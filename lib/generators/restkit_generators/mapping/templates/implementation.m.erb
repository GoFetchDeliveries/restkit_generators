#import "<%= filename %>.h"
<% associations.each do |ass| -%>
#import "<%= ios_base_class_name(ass.name) %>+Mapping.h"
<% end -%>

@implementation <%= ios_base_class_name %> (<%= category_name %>)

+ (RKObjectMapping *)<%= category_name.camelize(:lower) %>
{
  RKManagedObjectStore *managedObjectStore = [RKManagedObjectStore defaultStore];
  RKEntityMapping *mapping = [RKEntityMapping mappingForEntityForName:@"<%= ios_class_name(model_name) %>"
                                                 inManagedObjectStore:managedObjectStore];
  mapping.identificationAttributes = @[@"primaryKey"];

  // Plain attributes
  [mapping addAttributeMappingsFromDictionary:
  @{
<%= columns.map(&:name).map{ |atr| 
"   @\"#{atr}\" : @\"#{ios_attr_name(atr)}\"" }.join(",\n")
%>
  }];

<% has_many_associations.map(&:name).each do |k| -%>
  // Has Many <%= ios_class_name(k).pluralize %> 
  [mapping addPropertyMapping:[RKRelationshipMapping relationshipMappingFromKeyPath:@"<%= k %>"
                                                                          toKeyPath:@"<%= ios_attr_name(k) %>"
                                                                        withMapping:[<%= ios_base_class_name(k) %> mapping]]];
  NSRelationshipDescription *<%= ios_attr_name(k) %>Relationship =
  [[mapping.entity relationshipsByName] valueForKey:@"<%= ios_attr_name(k) %>"];

  RKConnectionDescription *<%= ios_attr_name(k) %>Connection =
  [[RKConnectionDescription alloc] initWithRelationship:<%= ios_attr_name(k) %>Relationship
                                             attributes:@{ @"<%= ios_attr_name(k) %>" : @"<%= id_name %>" }];
  [mapping addConnection:<%= ios_attr_name(k) %>Connection];

<% end -%>

<% belongs_to_associations.map(&:name).each do |k| -%>
  // Has One <%= ios_class_name(k) %>
  NSRelationshipDescription *<%= ios_attr_name(k) %>Relationship =
  [[mapping.entity relationshipsByName] valueForKey:@"<%= ios_attr_name(k) %>"];
  
  RKConnectionDescription *<%= ios_attr_name(k) %>Connection =
  [[RKConnectionDescription alloc] initWithRelationship:<%= ios_attr_name(k) %>Relationship
                                             attributes:@{ @"<%= ios_attr_name(k.to_s + "_id") %>" : @"<%= id_name %>" }];
  [mapping addConnection:<%= ios_attr_name(k) %>Connection];
<% end -%>

  return mapping;
}

@end