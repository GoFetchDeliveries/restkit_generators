#import "<%= filename %>.h"

@implementation RKObjectMapping (<%= category_name %>)

+ (RKObjectMapping *)<%= category_name.camelize(:lower) %>
{
  RKManagedObjectStore *managedObjectStore = [RKManagedObjectStore defaultStore];
  RKEntityMapping *mapping = [RKEntityMapping mappingForEntityForName:@"<%= ios_class_name(serializer.model_class.name) %>"
                                                 inManagedObjectStore:managedObjectStore];
  mapping.identificationAttributes = @[@"primaryKey"];

  // Plain attributes
  [mapping addAttributeMappingsFromDictionary:
  @{
<%= serializer.schema[:attributes].keys.map{|atr| 
"   @\"#{atr}\" : @\"#{ios_attr_name(atr)}\"" }.join(",\n")
%>
  }];

<% included_has_many_associations.each do |k| -%>
  // Has Many <%= ios_class_name(k).pluralize %> 
  [mapping addPropertyMapping:[RKRelationshipMapping relationshipMappingFromKeyPath:@"<%= k %>"
                                                                          toKeyPath:@"<%= ios_attr_name(k) %>"
                                                                        withMapping:[<%= ios_class_name(k) %> mapping]]];
  NSRelationshipDescription *<%= ios_attr_name(k) %>Relationship =
  [[mapping.entity relationshipsByName] valueForKey:@"<%= ios_attr_name(k) %>"];

  RKConnectionDescription *<%= ios_attr_name(k) %>Connection =
  [[RKConnectionDescription alloc] initWithRelationship:<%= ios_attr_name(k) %>Relationship
                                             attributes:@{ @"<%= ios_attr_name(k) %>" : @"<%= id_name %>" }];
  [mapping addConnection:<%= ios_attr_name(k) %>Connection];

<% end -%>

<% included_belongs_to_associations.each do |k| -%>
  // Has One <%= ios_class_name(k) %>
  NSRelationshipDescription *<%= ios_attr_name(k) %>Relationship =
  [[mapping.entity relationshipsByName] valueForKey:@"<%= ios_attr_name(k) %>"];
  
  RKConnectionDescription *<%= ios_attr_name(k) %>Connection =
  [[RKConnectionDescription alloc] initWithRelationship:<%= ios_attr_name(k) %>Relationship
                                             attributes:@{ @"<%= k %>_id" : @"<%= id_name %>" }];
  [mapping addConnection:<%= ios_attr_name(k) %>Connection];
<% end -%>

  return mapping;
}

@end